<html>
<head>
	<title>PNCS - Catasto</title>

	<meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="pncs-styles.css">
	
    <link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>


</head>

<body>


        <div id="container">
            <div id="header">
               <div id="navigation"></div><!--#navigation-->
            </div><!--#header-->

            <div id="main">
                    <div id="catasto"></div>
            </div><!--#main-->
            <div id="sidebar"></div><!--#sidebar-->
            <div id="footer"></div><!--#footer-->
        </div>


<script>

    var ETRS89width= 18.99-5.93;
    var startResolution = ETRS89width/1024;
    var grid_resolution = new Array(22);

    for (var i = 0; i < 22; ++i) {
        grid_resolution[i] = startResolution / Math.pow(2, i);
    }
    var crs_6706 = new L.Proj.CRS('EPSG:6706',
        '+proj=longlat +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +no_defs',
        {
            resolutions: grid_resolution,
            origin: [0, 0],
            bounds: L.bounds([5.93, 34.76], [18.99, 47.1])
        });

	var map = L.map('catasto').setView([41.890218, 12.492421], 18);

    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 21,
		attribution: 'PNCS - AlmavivA S.p.A.',
		id: 'mapbox/streets-v11',
		tileSize: 512,
        minZoom: 10,
		zoomOffset: -1
	}).addTo(map);  

    L.Control.geocoder({
        geocoder: L.Control.Geocoder.photon()
     }).addTo(map);
 
    var basemaps = {
        Particelle: L.tileLayer.wms('https://wms.cartografia.agenziaentrate.gov.it/inspire/wms/ows01.php', {
            layers: 'CP.CadastralParcel',
            crs: crs_6706,
            format: 'image/png',
	    version: '1.1.1',
            maxZoom: 21,
            transparent: true
        }),

        Province: L.tileLayer.wms('https://wms.cartografia.agenziaentrate.gov.it/inspire/wms/ows01.php', {
            layers: 'province',
            crs: crs_6706,
            format: 'image/png',
	    version: '1.1.1',
            maxZoom: 21,
            transparent: true
        }),


        Fabbricati: L.tileLayer.wms('https://wms.cartografia.agenziaentrate.gov.it/inspire/wms/ows01.php', {
            layers: 'fabbricati',
            crs: crs_6706,
            format: 'image/png',
	    version: '1.1.1',
            maxZoom: 21,
            transparent: true
        }),

        Vestizioni: L.tileLayer.wms('https://wms.cartografia.agenziaentrate.gov.it/inspire/wms/ows01.php', {
            layers: 'vestizioni',
            crs: crs_6706,
            format: 'image/png',
	    version: '1.1.1',
            maxZoom: 21,
            transparent: true
        }),
        
        Acque: L.tileLayer.wms('https://wms.cartografia.agenziaentrate.gov.it/inspire/wms/ows01.php', {
            layers: 'acque',
            crs: crs_6706,
            format: 'image/png',
            maxZoom: 21,
	    version: '1.1.1',
            transparent: true
        }),
        
        Strade: L.tileLayer.wms('https://wms.cartografia.agenziaentrate.gov.it/inspire/wms/ows01.php', {
            layers: 'strade',
            crs: crs_6706,
            format: 'image/png',
            maxZoom: 21,
	    version: '1.1.1',
            transparent: true
        }),

        Mappe: L.tileLayer.wms('https://wms.cartografia.agenziaentrate.gov.it/inspire/wms/ows01.php', {
            layers: 'CP.CadastralZoning',
            crs: crs_6706,
            format: 'image/png',
            maxZoom: 21,
	    version: '1.1.1',
            transparent: true
        })
    };

    L.control.layers(null, basemaps).addTo(map);



    function getFeatureInfoUrl(map, layer, latlng, crs) {
    var point = map.latLngToContainerPoint(latlng, map.getZoom()),
	    size = map.getSize(),
        bounds = map.getBounds(),
        sw = bounds.getSouthWest(),
        ne = bounds.getNorthEast(),
        sw = crs.projection._proj.forward([sw.lng, sw.lat]),
        ne = crs.projection._proj.forward([ne.lng, ne.lat]);
 
    var defaultParams = {
        request: 'GetFeatureInfo',
        service: 'WMS',
        srs: 'EPSG:6706',
        styles: '',
        version: layer._wmsVersion,
        format: layer.options.format,
        bbox: [sw.join(','), ne.join(',')].join(','),
        height: size.y,
        width: size.x,
        layers: layer.options.layers,
        query_layers: layer.options.layers,
        info_format: 'text/html'
    };
    params = L.Util.extend(defaultParams);
    params[params.version === '1.1.1' ? 'i' : 'x'] = point.x;
    params[params.version === '1.1.1' ? 'j' : 'y'] = point.y;
 
    return layer._url + L.Util.getParamString(params, layer._url, true);
}

  var popup = L.popup({maxWidth: 500});


 
//gestione dell'evento click sulla mappa
map.on('click', function(evt) {
 var coord =evt.latlng;
 //invocata la funzione per generare l'URL della richiesta GetFeatureInfo 
 var gFIurl = getFeatureInfoUrl(map, basemaps.Particelle, coord, crs_6706);
 if (gFIurl) {
	var xhttp;
        //istanza di una richiesta XHTTP
	xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
	if (this.readyState == 4 && this.status == 200) {
	   popup
           .setLatLng(coord)
           .setContent(xhttp.responseText)
           .openOn(map);;
	}
  };
  //bypass CORS policy
  xhttp.open("GET", "https://cors-anywhere.herokuapp.com/" + gFIurl, true);
  xhttp.send();
 }
})

    basemaps.Particelle.on("tileerror", function(tileerror) {
        var tileurl = basemaps.Particelle.getTileUrl(tileerror.coords);
        tileerror.tile.src = tileurl + "&rnd=" +Math.random();
    });

    basemaps.Province.on("tileerror", function(tileerror) {
        var tileurl = basemaps.Province.getTileUrl(tileerror.coords);
        tileerror.tile.src = tileurl + "&rnd=" +Math.random();
    });

    basemaps.Fabbricati.on("tileerror", function(tileerror) {
        var tileurl = basemaps.Fabbricati.getTileUrl(tileerror.coords);
        tileerror.tile.src = tileurl + "&rnd=" +Math.random();
    });

    basemaps.Vestizioni.on("tileerror", function(tileerror) {
        var tileurl = basemaps.Vestizioni.getTileUrl(tileerror.coords);
        tileerror.tile.src = tileurl + "&rnd=" +Math.random();
    });

    basemaps.Mappe.on("tileerror", function(tileerror) {
        var tileurl = basemaps.Mappe.getTileUrl(tileerror.coords);
        tileerror.tile.src = tileurl + "&rnd=" +Math.random();
    });

    basemaps.Acque.on("tileerror", function(tileerror) {
        var tileurl = basemaps.Acque.getTileUrl(tileerror.coords);
        tileerror.tile.src = tileurl + "&rnd=" +Math.random();
    });

    basemaps.Strade.on("tileerror", function(tileerror) {
        var tileurl = basemaps.Strade.getTileUrl(tileerror.coords);
        tileerror.tile.src = tileurl + "&rnd=" +Math.random();
    });

</script>

</body>
</html>
